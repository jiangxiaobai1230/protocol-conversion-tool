# 需求详细说明

## 1. 核心功能需求

## 1.1 表格自动识别与提取
**详细说明**：系统需要能够自动识别Word文档中的表格，区分有效数据表格和非目标表格，并准确提取目标表格内容。

**实际例子**：
- **有效数据表格**：包含"序号"、"参数"、"数据类型"、"值域"、"单位"等字段的表格
- **非目标表格**：包含"格式10"、"接收组播地址"、"占位符"等特征词的表格（来自illegal_table_feature.json）
- **识别过程**：
    - 扫描文档中的所有表格
    - 检查表头是否包含非目标特征词，如"格式10"、"占位符"等
    - 排除包含这些特征词的表格
    - 对剩余表格进行标准字段匹配

## 1.2 多协议类型支持
**详细说明**：支持总线、串行、网络等多种通信协议，每种协议有不同的表头结构和数据格式。

**实际例子**：
- **总线协议表格**：
  ```
  表头：["信息名称", "信息标识"]
  数据行：["温度传感器数据", "TEMP_001"]
  ```

- **网络协议表格**：
  ```
  表头：["序号", "信源", "信宿", "信息内容", "接收组播地址", "接收端口号"]
  数据行：["1", "Sensor1", "Controller", "温度数据", "239.255.0.1", "8080"]
  ```

- **串行协议表格**：
  ```
  表头：["ID序号", "ID定义", "是否有数据"]
  数据行：["0x1001", "温度传感器", "是"]
  ```

## 1.3 数据字段映射与转换
**详细说明**：将提取的原始数据按照标准模板进行字段映射，并使用data_type_transfer_keywords.json进行数据类型标准化。

**实际例子**：
- **数据类型转换**：
    - 原始数据："USHORT" → 标准化："UINT16"（来自datatype_name_mapping）
    - 原始数据："16位无符号整型" → 标准化："UINT16"
    - 原始数据："浮点型" → 标准化："FLOAT"

- **字段映射**：
    - 原始字段："信号名称" → 标准字段："参数"
    - 原始字段："字节数" → 标准字段："数据长度（字节）"
    - 原始字段："取值范围" → 标准字段："值域"

## 2. 表头识别优化需求

## 2.1 多策略表头识别
**详细说明**：结合多种策略识别表头，提高对非标准表格的识别准确率。

**实际例子**：
- **策略1：基于模板匹配**
    - 标准模板：["序号", "参数", "数据类型", "数据长度（字节）", "值域", "单位", "备注"]
    - 实际表头：["序号", "信号名称", "数据类型", "字节数", "取值范围", "单位", "说明"]
    - 匹配结果：通过模糊匹配识别为同一模板

- **策略2：基于特征词排除**
    - 发现表头包含"格式10" → 排除该表格（非目标表格）
    - 发现表头包含"占位符" → 排除该表格
    - 发现表头包含"接收组播地址" → 排除该表格

- **策略3：基于行列数变化**
    - 表格前几行：2列（信息名称行）
    - 后续行：7列（数据行）
    - 识别：行列数变化处为表头开始位置

## 2.2 模糊匹配与语义识别
**详细说明**：支持表头的模糊匹配和语义相似度识别。

**实际例子**：
- **模糊匹配**：
    - 标准字段："参数" vs 实际字段："信号名称" → 相似度0.8 → 自动匹配
    - 标准字段："数据类型" vs 实际字段："数据类型" → 相似度1.0 → 完全匹配
    - 标准字段："值域" vs 实际字段："取值范围" → 相似度0.9 → 自动匹配

- **语义识别**：
    - "信号名称"与"参数"的语义相似度计算
    - "字节数"与"数据长度"的语义相似度计算
    - 相似度>0.7：自动匹配；相似度<0.7：需要人工确认

## 3. 人机协同与交互需求

## 3.1 人工干预界面（双模式支持）
**详细说明**：当自动识别失败或置信度低时，提供图形化界面供人工干预。支持拖拽和输入两种方式，无缝转换。

**实际例子**：
- **拖拽匹配界面**：
  ```
  左侧（原始表头）：     右侧（标准字段）：
  +--------------+      +------------------+
  | 信号名称     | <--> | 参数             |
  | 数据类型     | <--> | 数据类型         |
  | 字节数       | <--> | 数据长度（字节） |
  | 取值范围     | <--> | 值域             |
  +--------------+      +------------------+
  ```

- **输入方式**（无缝转换）：
  ```
  原始字段：代号
  输入框：[序号 ▼]  （支持自动补全和搜索）
  系统自动完成匹配
  ```

- **双模式特点**：
    - 用户可随时在拖拽和输入方式间切换
    - 避免界面交互卡住
    - 拖拽方式适合字段较少的场景
    - 输入方式适合字段较多的场景

- **表格区域修正**：
    - 用户发现表格边界识别错误
    - 拖拽调整表格范围，重新定义数据区域
    - 系统重新提取调整后的表格数据

## 3.2 推荐修改流程优化
**详细说明**：当用户对模型推荐不满意时，直接进入人工干预流程，而不是显示其他候选项。

**实际例子**：
- **原流程**：
  ```
  模型推荐 → 显示其他候选项 → 用户选择 → 自动转换
  ```

- **新流程**：
  ```
  模型推荐 → 用户点击"修改" → 直接进入人工干预流程 → 用户选择 → 自动转换
  ```

- **优势**：
    - 减少中间步骤，提高用户效率
    - 用户可以直接进行精确匹配
    - 更灵活的匹配方式

## 3.3 外挂知识库系统
**详细说明**：建立字段映射关系的知识库，支持复用和版本管理。所有用户操作都自动保存到知识库。

**实际例子**：
- **知识库条目**：
  ```
  条目1（自动匹配）：
  - 原始字段：信号名称
  - 标准字段：参数
  - 操作类型：自动匹配
  - 置信度：1.0
  - 来源：知识库精确匹配
  - 标注时间：2024-12-20
  - 版本ID：v1.2

  条目2（推荐确认）：
  - 原始字段：字节数
  - 标准字段：数据长度（字节）
  - 操作类型：推荐确认
  - 置信度：0.9
  - 来源：模型推荐（相似度0.92）
  - 用户确认：user_001
  - 标注时间：2024-12-20
  - 版本ID：v1.2

  条目3（人工干预）：
  - 原始字段：代号
  - 标准字段：序号
  - 操作类型：人工干预
  - 置信度：1.0
  - 来源：用户拖拽连线或输入
  - 用户：user_001
  - 标注时间：2024-12-20
  - 版本ID：v1.2
  ```

- **使用场景**：
    - 下次遇到"信号名称"字段时，自动映射到"参数"
    - 下次遇到"字节数"字段时，直接使用知识库，无需再次推荐
    - 下次遇到"代号"字段时，直接使用知识库，无需人工干预
    - 如果版本更新导致字段含义变化，通过版本ID隔离不同场景

## 4. 数据处理与清洗需求

## 4.1 数据完整性检查
**详细说明**：对提取的数据进行完整性检查，确保必备字段存在。

**实际例子**：
- **必备字段检查**：
    - 检查每条记录是否包含："信息名称"、"内容"、"转换类型"
    - 发现缺失"信息名称"的记录：
      ```
      原始记录：{"内容": "温度值", "转换类型": "FLOAT"}
      处理结果：{"信息名称": "临时_温度值", "内容": "温度值", "转换类型": "FLOAT"}
      ```

- **异常数据处理**：
    - 数据类型转换错误：
      ```
      原始数据：数据类型 = "UNKNOWN_TYPE"
      处理结果：数据类型 = "ERROR_UNKNOWN_TYPE"，bit类型 = "0"
      ```

## 4.2 特殊字段处理
**详细说明**：对值域、单位、转换公式等字段进行结构化提取。

**实际例子**：
- **值域处理**：
    - 原始值域："0~100"
    - 结构化结果：{"最小值": 0, "最大值": 100, "类型": "数值范围"}

    - 原始值域："-40~85℃"
    - 结构化结果：{"最小值": -40, "最大值": 85, "单位": "℃", "类型": "带单位数值范围"}

- **单位处理**：
    - 原始单位："℃" → 标准单位："摄氏度"
    - 原始单位："%" → 标准单位："百分比"
    - 原始单位："m/s" → 标准单位："米每秒"

- **转换公式处理**：
    - 原始公式："y = 0.1x + 256"
    - 结构化结果：{"公式类型": "线性", "比例系数": 0.1, "偏移量": 256}

    - 原始公式："温度 = 原始值 × 0.1 + 256"
    - 结构化结果：{"公式类型": "线性", "比例系数": 0.1, "偏移量": 256, "描述": "温度转换公式"}

## 5. 性能与质量保障需求

## 5.1 性能优化
**详细说明**：确保系统处理大量表格时的性能表现。

**实际例子**：
- **批量处理**：
    - 处理30页文档，每页3-5个表格
    - 优化前：逐个处理，总耗时5分钟
    - 优化后：批量处理，总耗时30秒

- **内存管理**：
    - 大文档处理时，采用流式读取
    - 避免一次性加载所有表格数据到内存
    - 处理完成后及时释放资源

## 5.2 测试与质量保证
**详细说明**：建立完整的测试体系，确保代码可靠性。

**实际例子**：
- **测试数据**：
    - 标准表格：包含完整字段的正常表格
    - 非标准表格：字段名称变体、合并单元格等
    - 异常表格：包含"格式10"、"占位符"等非目标特征词的表格

- **测试场景**：
    - 场景1：标准总线协议表格提取
    - 场景2：非标准表头字段的模糊匹配
    - 场景3：包含非目标特征词的表格过滤
    - 场景4：数据类型转换和标准化

## 6. 通信协议字段内置需求

## 6.1 常用选项内置
**详细说明**：在系统中内置常用的协议字段选项，减少用户配置工作量。

**实际例子**：
- **预设字段组**：
    - 总线协议字段组：["信息名称", "信息标识", "信源系统码", "信源机器码", "信宿系统码", "信宿机器码"]
    - 网络协议字段组：["信息内容", "接收组播地址", "接收端口号", "消息ID", "信源", "信宿"]
    - 串行协议字段组：["ID序号", "ID定义", "参数", "数据类型", "数据长度"]

- **预设数据类型**：
    - 基础类型：["INT8", "UINT8", "INT16", "UINT16", "INT32", "UINT32", "FLOAT", "DOUBLE"]
    - 中文描述：["8位无符号整型", "16位有符号整型", "浮点型", "双精度浮点型"]

- **预设单位**：
    - 温度单位：["℃", "℉", "K"]
    - 湿度单位：["%"]
    - 速度单位：["m/s", "km/h", "mph"]
    - 电压单位：["V", "mV", "kV"]

## 7. 多表关联与复杂逻辑需求

## 7.1 多表数据关联
**详细说明**：支持通过键值匹配关联多个表的数据。

**实际例子**：
- **端口表与ID表关联**：
    - 端口表：
      ```
      | 信息内容 | 接收端口号 | 信源   |
      |----------|------------|--------|
      | 温度数据 | 8080       | Sensor1|
      | 湿度数据 | 8081       | Sensor2|
      ```

    - ID表：
      ```
      | 信息内容 | 消息ID  |
      |----------|---------|
      | 温度数据 | 0x1001  |
      | 湿度数据 | 0x1002  |
      ```

    - 关联结果：
      ```
      | 信息内容 | 接收端口号 | 信源   | 消息ID  |
      |----------|------------|--------|---------|
      | 温度数据 | 8080       | Sensor1| 0x1001  |
      | 湿度数据 | 8081       | Sensor2| 0x1002  |
      ```

## 7.2 总线标识符解析
**详细说明**：完善总线表中信源、机器码等字段的解析规则。

**实际例子**：
- **地址字符串解析**：
    - 输入："BC RT2-SA1-7"
    - 解析结果：
        - 信源：BC
        - 信宿：RT2
        - 子地址：1
        - 数据长度：7

    - 输入："RT3-SA2-5"
    - 解析结果：
        - 信源：（空）
        - 信宿：RT3
        - 子地址：2
        - 数据长度：5

## 8. Excel输出与推荐确认标记需求

## 8.1 Excel输出格式
**详细说明**：将转换后的数据输出为Excel文件，对推荐确认的字段添加标记和颜色。

**实际例子**：
- **Excel输出结构**：
  ```
  | 名称 | 参数 | 数据类型 | 数据长度 | 值域 | 单位 | 备注 | 推荐确认 |
  |------|------|----------|----------|------|------|------|----------|
  | 温度 | 温度 | FLOAT    | 4        | -40~85 | ℃ | 环境温度 | |
  | 湿度 | 湿度 | UINT8    | 1        | 0~100 | % | 相对湿度 | ⚠️ |
  | 压力 | 压力 | UINT16   | 2        | 0~1000 | Pa | 大气压力 | |
  ```

- **标记说明**：
    - **推荐确认 ⚠️**：黄色背景，表示用户确认的模型推荐，需要后续验证
    - 其他字段无标记

- **Excel筛选功能**：
    - 用户可以通过"推荐确认"列进行筛选
    - 快速查看所有用户确认的推荐字段
    - 便于后续审核和质量检查

## 8.2 质量检查流程
**详细说明**：通过Excel标记和筛选功能进行质量检查。

**实际例子**：
- **检查流程**：
  ```
  1. 系统自动标记所有推荐确认的字段
  2. 用户通过"推荐确认"列筛选需要验证的字段
  3. 重点审核所有标记为推荐确认的字段
  4. 如发现错误，可以批量修正并更新知识库
  ```

- **筛选示例**：
  ```
  筛选条件：显示所有"推荐确认"字段
  → 查看所有用户确认的推荐，进行二次验证
  ```

---

## 9. 技术实现需求

## 9.1 开发语言与架构
**详细说明**：明确技术栈和架构要求。

**实际例子**：
- **模块化架构**：
    - 表格识别模块：负责识别和过滤表格
    - 字段映射模块：负责字段名称标准化
    - 数据转换模块：负责数据类型转换
    - 知识库模块：负责存储和查询映射关系
    - 用户界面模块：负责人机交互

- **数据处理流程**：
    1. 读取Word文档
    2. 识别所有表格
    3. 过滤非目标表格（使用illegal_table_feature.json）
    4. 提取目标表格数据
    5. 字段映射和标准化
    6. 数据类型转换（使用data_type_transfer_keywords.json）
    7. 输出Excel文件

## 9.2 数据结构设计
**详细说明**：完善数据结构设计，支持灵活扩展。

**实际例子**：
- **表格特征词库**（illegal_table_feature.json）：
  ```
  {
    "Template": [
      ["格式10"],                    // 非目标表格特征
      ["接收组播地址"],             // 非目标表格特征  
      ["占位符"],                   // 非目标表格特征
      ["序号","信源","信宿","信息内容","消息ID"],  // 目标表格特征
      ["字节号","意义","说明"]      // 目标表格特征
    ]
  }
  ```

- **数据类型映射库**（data_type_transfer_keywords.json）：
  ```
  {
    "datatype_name_mapping": {
      "UINT8|UCHAR|unsigned char|8位无符号整型": "UINT8",
      "INT8|CHAR|signed char8位有符号整型": "INT8",
      "FLOAT|浮点型": "FLOAT"
    },
    "datatype_bit_mapping": {
      "UINT8": 8,
      "INT8": 8,
      "FLOAT": 32
    }
  }
  ```

这些详细的说明和实际例子展示了每个需求的具体应用场景和处理方式，为开发工作提供了清晰的指导。所有例子都基于实际的业务场景和新增的配置文件，确保需求的实用性和可操作性

我已经基于新增文件重新分析了所有需求，并提供了详细的文字说明和实际例子。总结如下：

# 需求总结

## 关键新增内容
1. **illegal_table_feature.json**：定义了非目标表格的特征词，用于过滤不需要处理的表格
2. **data_type_transfer_keywords.json**：提供了完整的数据类型映射关系，支持多种格式的数据类型标准化
3. **测试协议20251216.docx**：包含了值域、单位、转换公式的实际例子和解释

## 主要改进点
1. **表格识别更精准**：通过特征词库可以准确区分目标表格和非目标表格
2. **数据类型标准化**：支持更多种数据类型格式的自动转换
3. **处理流程更完整**：从表格识别、过滤、提取到标准化形成完整流程

