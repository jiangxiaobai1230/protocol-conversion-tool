# 协议转换工具 - 两期开发规划

## 项目概述

本项目分为两期开发：
- **第一期**：基于知识库的精确匹配转换系统
- **第二期**：基于嵌入模型的模糊匹配转换系统

---

## 第一期：知识库精确匹配系统（核心功能）

### 第一期核心理念
- **完全精确匹配**：只有在知识库中找到完全匹配的字段映射关系时，才能自动进行协议转换
- **人工干预机制**：遇到知识库中没有的字段映射关系时，通过拖拽连线界面进行人工匹配
- **自动学习**：人工匹配完成后，自动将该映射关系记录到知识库，下次遇到相同情况无需人工干预

### 第一期需求详细说明

#### 需求1：表格自动识别与过滤

**需求描述**：系统能够自动识别Word文档中的表格，并过滤掉非目标表格。

**详细说明**：
- 扫描Word文档中的所有表格
- 使用illegal_table_feature.json中的特征词过滤非目标表格
- 识别并提取目标表格的数据

**实际例子**：

假设Word文档中有以下表格：

表格1（非目标表格）：
```
| 格式10 | 说明 |
|--------|------|
| 格式A  | 描述 |
```
→ 系统识别到"格式10"特征词，排除该表格

表格2（目标表格）：
```
| 序号 | 参数 | 数据类型 | 值域 | 单位 | 备注 |
|------|------|----------|------|------|------|
| 1    | 温度 | FLOAT    | -40~85 | ℃ | 环境温度 |
```
→ 系统识别为目标表格，进行提取

**第一期实现**：
- 基于特征词库的精确过滤
- 不需要复杂的表头识别算法
- 简单的表格结构识别

---

#### 需求2：知识库系统设计与实现

**需求描述**：建立字段映射关系的知识库，支持存储、查询和版本管理。

**详细说明**：
- 知识库存储所有已知的字段映射关系
- 支持按协议类型、供应商等维度进行分类
- 每条映射关系包含版本ID，支持版本隔离
- 支持快速查询和精确匹配

**知识库数据结构**：

```
知识库条目示例：

条目ID: KB_001
协议类型: 总线通信协议
供应商/来源: supplier_A
原始字段: 信号名称
标准字段: 参数
置信度: 1.0（人工标注）
标注时间: 2024-12-20 10:30:00
标注者: user_001
版本ID: v1.0
备注: 总线协议中的信号名称统一映射到参数字段

条目ID: KB_002
协议类型: 网络通信协议
供应商/来源: supplier_B
原始字段: 字节数
标准字段: 数据长度（字节）
置信度: 1.0（人工标注）
标注时间: 2024-12-20 11:00:00
标注者: user_002
版本ID: v1.0
备注: 网络协议中的字节数映射到数据长度
```

**实际例子**：

场景1：处理第一个总线协议文档
- 文档中的表头：["序号", "信号名称", "数据类型", "字节数", "取值范围", "单位", "说明"]
- 系统查询知识库：
  - "序号" → 知识库中有匹配 → 自动映射到"序号"
  - "信号名称" → 知识库中有匹配 → 自动映射到"参数"
  - "数据类型" → 知识库中有匹配 → 自动映射到"数据类型"
  - "字节数" → 知识库中有匹配 → 自动映射到"数据长度（字节）"
  - "取值范围" → 知识库中有匹配 → 自动映射到"值域"
  - "单位" → 知识库中有匹配 → 自动映射到"单位"
  - "说明" → 知识库中有匹配 → 自动映射到"备注"
- 结果：所有字段都找到了匹配，自动进行转换，无需人工干预

场景2：处理第二个来自不同供应商的协议文档
- 文档中的表头：["代号", "内容", "类型", "字节", "值", "单位", "区间"]
- 系统查询知识库：
  - "代号" → 知识库中无匹配 → 需要人工干预
  - "内容" → 知识库中无匹配 → 需要人工干预
  - "类型" → 知识库中有匹配 → 自动映射到"数据类型"
  - "字节" → 知识库中无匹配 → 需要人工干预
  - "值" → 知识库中无匹配 → 需要人工干预
  - "单位" → 知识库中有匹配 → 自动映射到"单位"
  - "区间" → 知识库中无匹配 → 需要人工干预
- 结果：部分字段无法自动匹配，触发人工干预流程

---

#### 需求3：人工干预界面（拖拽连线匹配）

**需求描述**：当知识库中找不到字段映射关系时，提供拖拽连线界面供用户进行人工匹配。

**详细说明**：
- 显示原始表头和标准字段
- 支持拖拽连线进行字段匹配
- 用户可以一对一或一对多进行映射
- 支持跳过某些字段（标记为不需要转换）
- 完成匹配后自动保存到知识库

**拖拽连线界面示例**：

```
┌─────────────────────────────────────────────────────────────┐
│ 字段映射匹配界面                                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 原始表头（来自协议文档）    标准字段（转换目标）              │
│ ┌──────────────────┐      ┌──────────────────┐              │
│ │ 代号         ●───┼──────┼─→ 序号           │              │
│ │              │   │      │                  │              │
│ │ 内容         ●───┼──────┼─→ 参数           │              │
│ │              │   │      │                  │              │
│ │ 类型         ●───┼──────┼─→ 数据类型       │              │
│ │              │   │      │                  │              │
│ │ 字节         ●───┼──────┼─→ 数据长度       │              │
│ │              │   │      │                  │              │
│ │ 值           ●───┼──────┼─→ 值域           │              │
│ │              │   │      │                  │              │
│ │ 单位         ●───┼──────┼─→ 单位           │              │
│ │              │   │      │                  │              │
│ │ 区间         ●───┼──────┼─→ 备注           │              │
│ │              │   │      │                  │              │
│ └──────────────────┘      └──────────────────┘              │
│                                                               │
│ [保存映射关系] [跳过] [取消]                                  │
└─────────────────────────────────────────────────────────────┘
```

**实际例子**：

用户操作流程：
1. 系统检测到"代号"字段无法在知识库中找到匹配
2. 弹出拖拽连线界面
3. 用户拖拽"代号"连接到"序号"
4. 用户拖拽"内容"连接到"参数"
5. 用户拖拽"字节"连接到"数据长度（字节）"
6. 用户拖拽"值"连接到"值域"
7. 用户拖拽"区间"连接到"备注"
8. 用户点击"保存映射关系"
9. 系统自动将这些映射关系保存到知识库
10. 下次遇到相同的字段名称时，系统可以直接使用这些映射关系，无需人工干预

---

#### 需求4：数据类型标准化

**需求描述**：使用data_type_transfer_keywords.json进行数据类型的标准化转换。

**详细说明**：
- 支持多种数据类型格式的识别和转换
- 自动映射到标准数据类型
- 同时获取对应的bit位数

**实际例子**：

原始数据类型转换：
```
原始数据类型: "USHORT"
查询data_type_transfer_keywords.json
匹配结果: "UINT16|USHROT|16位无符号整型" → "UINT16"
获取bit数: "UINT16" → 16
最终结果: {"标准类型": "UINT16", "bit位数": 16}

原始数据类型: "16位无符号整型"
查询data_type_transfer_keywords.json
匹配结果: "UINT16|USHROT|16位无符号整型" → "UINT16"
获取bit数: "UINT16" → 16
最终结果: {"标准类型": "UINT16", "bit位数": 16}

原始数据类型: "浮点型"
查询data_type_transfer_keywords.json
匹配结果: "FLOAT|浮点型" → "FLOAT"
获取bit数: "FLOAT" → 32
最终结果: {"标准类型": "FLOAT", "bit位数": 32}
```

---

#### 需求5：数据提取与转换

**需求描述**：从协议文档中提取表格数据，并按照标准模板进行转换。

**详细说明**：
- 提取表格中的所有数据行
- 按照知识库中的字段映射关系进行转换
- 处理特殊字段（值域、单位、转换公式等）
- 输出标准格式的Excel文件

**实际例子**：

原始表格数据（来自协议文档）：
```
| 代号 | 内容 | 类型 | 字节 | 值 | 单位 | 区间 |
|------|------|------|------|-----|------|------|
| 1    | 温度 | FLOAT | 4 | -40~85 | ℃ | 环境温度 |
| 2    | 湿度 | UINT8 | 1 | 0~100 | % | 相对湿度 |
```

知识库映射关系：
```
代号 → 序号
内容 → 参数
类型 → 数据类型
字节 → 数据长度（字节）
值 → 值域
单位 → 单位
区间 → 备注
```

转换后的数据（输出到Excel）：
```
| 序号 | 参数 | 数据类型 | 数据长度（字节） | 值域 | 单位 | 备注 |
|------|------|----------|------------------|------|------|------|
| 1    | 温度 | FLOAT    | 4                | -40~85 | ℃ | 环境温度 |
| 2    | 湿度 | UINT8    | 1                | 0~100 | % | 相对湿度 |
```

---

#### 需求6：特殊字段处理

**需求描述**：对值域、单位、转换公式等特殊字段进行结构化处理。

**详细说明**：
- 值域：提取数值范围和单位
- 单位：标准化单位表示
- 转换公式：提取公式中的关键参数
- 备注：保留原始内容

**实际例子**：

值域处理：
```
原始值域: "0~100"
处理结果: {"最小值": 0, "最大值": 100}

原始值域: "-40~85℃"
处理结果: {"最小值": -40, "最大值": 85, "单位": "℃"}

原始值域: "0x00~0xFF"
处理结果: {"最小值": "0x00", "最大值": "0xFF", "格式": "十六进制"}
```

单位处理：
```
原始单位: "℃"
标准化: "摄氏度"

原始单位: "%"
标准化: "百分比"

原始单位: "m/s"
标准化: "米每秒"
```

转换公式处理：
```
原始公式: "y = 0.1x + 256"
提取结果: {"公式类型": "线性", "比例系数": 0.1, "偏移量": 256}

原始公式: "温度 = 原始值 × 0.1 + 256"
提取结果: {"公式类型": "线性", "比例系数": 0.1, "偏移量": 256, "描述": "温度转换公式"}

原始公式: "无转换"
提取结果: {"公式类型": "无", "描述": "无转换"}
```

---

#### 需求7：多协议类型支持

**需求描述**：支持总线、串行、网络等多种通信协议的处理。

**详细说明**：
- 识别协议类型
- 根据协议类型使用不同的处理策略
- 提取协议特定的字段信息

**实际例子**：

总线协议处理：
```
协议特征: 包含"信息名称"、"信息标识"等字段
处理流程:
1. 识别为总线协议
2. 提取信息名称和标识
3. 解析总线地址（如"BC RT2-SA1-7"）
4. 提取数据字段信息
5. 输出标准格式
```

网络协议处理：
```
协议特征: 包含"信源"、"信宿"、"接收组播地址"等字段
处理流程:
1. 识别为网络协议
2. 提取通信端点信息
3. 提取端口和地址信息
4. 提取数据字段信息
5. 输出标准格式
```

串行协议处理：
```
协议特征: 包含"ID序号"、"ID定义"等字段
处理流程:
1. 识别为串行协议
2. 提取ID信息
3. 提取数据字段信息
4. 输出标准格式
```

---

#### 需求8：输出与存储（含推荐确认标记）

**需求描述**：将转换后的数据输出为Excel文件，并支持知识库的持久化存储。对推荐确认的字段添加标记和颜色突出，支持Excel筛选。

**详细说明**：
- 输出标准格式的Excel文件
- 知识库数据持久化存储（数据库或JSON文件）
- 支持知识库的导入导出
- 推荐确认的字段添加标记和颜色
- 支持Excel中按"推荐确认"进行筛选

**实际例子**：

输出Excel文件结构（含推荐确认标记）：
```
Sheet1: 协议数据
| 名称 | 信源系统码 | 信源机器码 | 信宿系统码 | 信宿机器码 | 子地址 | 数据段长度 | ID | 内容 | 子内容 | 类型（bit） | 转换类型 | 判读公式 | 转换公式 | 单位 | 备注 | 推荐确认 |
|------|-----------|-----------|-----------|-----------|--------|-----------|-----|------|--------|------------|----------|----------|----------|------|------|----------|
| 温度 | SYS001    | MC001     | SYS002    | MC002     | 1      | 4         | 0x01 | 温度值 | | 32 | FLOAT | | y=0.1x+256 | ℃ | 环境温度 | |
| 湿度 | SYS001    | MC001     | SYS002    | MC002     | 2      | 1         | 0x02 | 湿度值 | | 8 | UINT8 | | | % | 相对湿度 | ⚠️ |
| 压力 | SYS001    | MC001     | SYS002    | MC002     | 3      | 2         | 0x03 | 压力值 | | 16 | UINT16 | | | Pa | 大气压力 | |
```

**标记说明**：
- **推荐确认** ⚠️：黄色背景，表示用户确认的模型推荐，需要后续验证

**Excel筛选功能**：
- 用户可以通过"推荐确认"列进行筛选
- 快速查看所有用户确认的推荐字段
- 便于后续审核和质量检查

知识库存储：
```
知识库文件: knowledge_base.json 或 knowledge_base.db
存储内容:
- 所有字段映射关系
- 协议类型信息
- 版本管理信息
- 标注者和时间信息
- 推荐确认标记
```

---

### 第一期工作流程总结

```
┌─────────────────────────────────────────────────────────────┐
│ 第一期工作流程                                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 1. 用户上传Word协议文档                                       │
│    ↓                                                          │
│ 2. 系统识别和过滤表格                                         │
│    ↓                                                          │
│ 3. 提取表格数据                                               │
│    ↓                                                          │
│ 4. 查询知识库进行字段映射                                     │
│    ↓                                                          │
│ 5. 判断是否所有字段都找到匹配                                 │
│    ├─ 是 → 自动转换 → 输出Excel                              │
│    └─ 否 → 触发人工干预                                       │
│           ↓                                                   │
│           用户进行拖拽连线匹配                                 │
│           ↓                                                   │
│           系统保存映射关系到知识库                             │
│           ↓                                                   │
│           自动转换 → 输出Excel                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 第二期：嵌入模型模糊匹配系统（智能增强）

### 第二期核心理念
- **模糊匹配**：使用嵌入模型计算字段名称的语义相似度
- **智能推荐**：根据相似度自动推荐最可能的标准字段
- **降低人工干预**：减少需要人工干预的情况
- **持续学习**：结合第一期的知识库数据进行模型优化

### 第二期需求详细说明

#### 需求1：嵌入模型集成

**需求描述**：集成轻量级嵌入模型（如Sentence-BERT或ERNIE 3.0 Tiny），用于计算字段名称的语义相似度。

**详细说明**：
- 选择轻量级模型，支持CPU推理
- 模型推理时间控制在秒级
- 支持中文语义理解
- 支持模型的微调和优化

**实际例子**：

模型推理示例：
```
输入字段1: "信号名称"
输入字段2: "参数"
模型计算相似度: 0.85
结论: 相似度较高，可以自动匹配

输入字段1: "字节数"
输入字段2: "数据长度（字节）"
模型计算相似度: 0.92
结论: 相似度很高，可以自动匹配

输入字段1: "格式"
输入字段2: "参数"
模型计算相似度: 0.45
结论: 相似度较低，需要人工确认
```

---

#### 需求2：多层次匹配策略

**需求描述**：实现多层次的匹配策略，逐步提高匹配准确率。

**详细说明**：
- 第一层：知识库精确匹配（来自第一期）
- 第二层：嵌入模型相似度匹配
- 第三层：基于上下文的智能推荐
- 第四层：人工干预

**实际例子**：

匹配流程示例：
```
处理字段: "信号名"

第一层 - 知识库精确匹配:
查询知识库: "信号名" → 无精确匹配
结果: 未找到

第二层 - 嵌入模型相似度匹配:
计算与所有标准字段的相似度:
- "序号": 0.32
- "参数": 0.88 ← 最高
- "数据类型": 0.25
- "值域": 0.18
- "单位": 0.15
- "备注": 0.22
结果: 推荐"参数"，相似度0.88

第三层 - 基于上下文的智能推荐:
分析表格结构和其他字段:
- 表格中有"数据类型"、"值域"等字段
- 这些字段通常与"参数"字段一起出现
- 进一步确认"参数"是最合适的匹配
结果: 确认推荐"参数"

第四层 - 用户确认:
系统显示推荐结果给用户:
"检测到字段'信号名'，推荐映射到'参数'（相似度88%）"
用户点击确认 → 自动转换
或用户点击修改 → 显示其他选项
```

---

#### 需求3：置信度阈值管理

**需求描述**：根据相似度设置不同的置信度阈值，自动决定是否需要人工干预。

**详细说明**：
- 高置信度（>0.85）：自动匹配，无需人工干预
- 中置信度（0.7-0.85）：显示推荐，用户可以快速确认
- 低置信度（<0.7）：需要人工干预

**实际例子**：

置信度处理示例：
```
场景1 - 高置信度自动匹配:
字段: "信号名称"
相似度: 0.92
阈值: 0.85
处理: 自动映射到"参数"，无需用户干预

场景2 - 中置信度推荐确认:
字段: "字节"
相似度: 0.78
阈值: 0.7
处理: 显示推荐"数据长度（字节）"，用户可以快速点击确认

场景3 - 低置信度人工干预:
字段: "格式"
相似度: 0.45
阈值: 0.7
处理: 触发拖拽连线界面，用户进行人工匹配
```

---

#### 需求4：模型微调与优化

**需求描述**：基于第一期的知识库数据，对嵌入模型进行微调和优化。

**详细说明**：
- 收集第一期中用户进行的所有人工匹配
- 使用这些数据作为训练样本
- 对模型进行微调，提高特定领域的匹配准确率
- 定期更新模型

**实际例子**：

模型微调流程：
```
第一期收集的训练数据:
1. "信号名称" → "参数" (用户确认)
2. "字节数" → "数据长度（字节）" (用户确认)
3. "取值范围" → "值域" (用户确认)
4. "说明" → "备注" (用户确认)
... (收集100+条映射关系)

微调过程:
1. 使用这些映射关系作为正样本
2. 生成负样本（错误的映射关系）
3. 对预训练模型进行微调
4. 评估微调后的模型性能

微调结果:
- 原始模型: "信号名称" vs "参数" 相似度 0.85
- 微调后: "信号名称" vs "参数" 相似度 0.95
- 提高了模型在该领域的准确率
```

---

#### 需求5：智能推荐与快速确认

**需求描述**：提供智能推荐界面，用户可以快速确认或修改推荐结果。

**详细说明**：
- 显示模型推荐的字段映射
- 显示相似度分数
- 提供快速确认按钮
- 提供修改选项（显示其他候选项）

**智能推荐界面示例**：

```
┌─────────────────────────────────────────────────────────────┐
│ 智能字段匹配推荐                                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 原始字段: "信号名称"                                          │
│                                                               │
│ 推荐映射: 参数 (相似度: 88%)                                  │
│                                                               │
│ [✓ 确认] [修改] [跳过]                                        │
│                                                               │
│ ─────────────────────────────────────────────────────────────│
│                                                               │
│ 其他候选项:                                                   │
│ • 内容 (相似度: 72%)                                          │
│ • 子内容 (相似度: 65%)                                        │
│ • 备注 (相似度: 48%)                                          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**实际例子**：

用户操作流程：
```
1. 系统检测到"信号名称"字段
2. 模型计算相似度，推荐"参数"（88%）
3. 用户看到推荐结果
4. 用户点击"确认"
5. 系统自动映射该字段
6. 继续处理下一个字段

或者：

1. 系统检测到"字节"字段
2. 模型计算相似度，推荐"数据长度（字节）"（78%）
3. 用户看到推荐结果
4. 用户觉得不太对，点击"修改"
5. 系统显示其他候选项
6. 用户选择"数据长度"
7. 系统自动映射该字段
```

---

#### 需求6：性能优化与缓存

**需求描述**：优化模型推理性能，支持批量处理和结果缓存。

**详细说明**：
- 批量计算相似度，减少推理次数
- 缓存常见字段的相似度计算结果
- 支持GPU加速（可选）
- 控制推理时间在秒级以内

**实际例子**：

性能优化示例：
```
场景1 - 批量处理:
原始表头: ["信号名称", "数据类型", "字节数", "取值范围", "单位", "说明"]
标准字段: ["序号", "参数", "数据类型", "数据长度（字节）", "值域", "单位", "备注"]

优化前:
- 逐个计算相似度
- 总耗时: 6秒

优化后:
- 批量计算所有相似度
- 总耗时: 1秒

场景2 - 缓存:
第一次处理"信号名称"字段:
- 计算与所有标准字段的相似度
- 结果缓存: {"信号名称": {"参数": 0.88, "内容": 0.72, ...}}

第二次处理"信号名称"字段:
- 直接从缓存中获取结果
- 无需重新计算
```

---

#### 需求7：多表关联与复杂逻辑

**需求描述**：支持多个表格之间的数据关联和复杂的转换逻辑。

**详细说明**：
- 识别多个表格之间的关联关系
- 通过共同字段进行数据关联
- 支持复杂的数据转换规则

**实际例子**：

多表关联示例：
```
协议文档中有三个表格:

表格1 - 端口配置表:
| 信息内容 | 接收端口号 | 信源 |
|----------|------------|------|
| 温度数据 | 8080       | Sensor1 |
| 湿度数据 | 8081       | Sensor2 |

表格2 - 消息ID表:
| 信息内容 | 消息ID |
|----------|--------|
| 温度数据 | 0x1001 |
| 湿度数据 | 0x1002 |

表格3 - 数据字段表:
| 信息内容 | 参数 | 数据类型 | 值域 | 单位 |
|----------|------|----------|------|------|
| 温度数据 | 温度 | FLOAT | -40~85 | ℃ |
| 湿度数据 | 湿度 | UINT8 | 0~100 | % |

系统处理流程:
1. 识别三个表格
2. 识别共同字段"信息内容"
3. 通过"信息内容"关联三个表格
4. 生成关联结果:
   | 信息内容 | 接收端口号 | 信源 | 消息ID | 参数 | 数据类型 | 值域 | 单位 |
   |----------|------------|------|--------|------|----------|------|------|
   | 温度数据 | 8080 | Sensor1 | 0x1001 | 温度 | FLOAT | -40~85 | ℃ |
   | 湿度数据 | 8081 | Sensor2 | 0x1002 | 湿度 | UINT8 | 0~100 | % |
```

---

#### 需求8：持续学习与反馈（包含人工干预反馈）

**需求描述**：系统能够从用户的所有操作中学习，包括自动确认、推荐确认、推荐修改和人工干预，不断改进匹配准确率。

**详细说明**：
- 记录用户的所有操作（确认、修改、人工干预）
- 所有用户操作都自动保存到知识库
- 分析用户操作的原因和模式
- 定期更新模型和知识库
- 提供学习效果的可视化

**实际例子**：

持续学习流程：
```
第一阶段 - 收集反馈（包含所有用户操作）:
用户处理100个协议文档
- 自动匹配成功: 850个字段 → 保存到知识库（置信度1.0）
- 用户确认推荐: 120个字段 → 保存到知识库（置信度0.9）
- 用户修改推荐: 20个字段 → 保存到知识库（置信度1.0，覆盖推荐）
- 用户手动匹配（人工干预）: 10个字段 → 保存到知识库（置信度1.0）

第二阶段 - 分析反馈:
- 自动匹配准确率: 85%
- 推荐确认率: 92%
- 推荐修改率: 8%
- 人工干预率: 1%
- 识别出容易出错的字段对
- 识别出用户经常修改的推荐

第三阶段 - 知识库更新:
- 所有用户操作都已实时保存到知识库
- 知识库现在包含: 850 + 120 + 20 + 10 = 1000条映射关系
- 下次处理相同字段时，可以直接使用这些映射关系

第四阶段 - 模型优化:
- 使用收集的反馈数据进行微调
- 重点优化容易出错的字段对
- 重点优化用户经常修改的推荐
- 提高模型的准确率

第五阶段 - 效果评估:
- 处理新的100个协议文档
- 自动匹配成功: 900个字段（提高5%）
- 用户确认推荐: 80个字段（减少40%）
- 用户修改推荐: 15个字段（减少25%）
- 用户手动匹配: 5个字段（减少50%）
- 知识库现在包含: 2000+条映射关系
```

**知识库记录详情**：

```
用户操作类型1 - 自动匹配确认:
原始字段: "信号名称"
标准字段: "参数"
操作类型: 自动匹配
置信度: 1.0
来源: 知识库精确匹配
保存时间: 2024-12-20 10:30:00
用户: system

用户操作类型2 - 推荐确认:
原始字段: "字节数"
标准字段: "数据长度（字节）"
操作类型: 推荐确认
置信度: 0.9
来源: 模型推荐（相似度0.92）
用户确认: user_001
保存时间: 2024-12-20 10:35:00

用户操作类型3 - 推荐修改:
原始字段: "格式"
模型推荐: "参数"（相似度0.65）
用户修改为: "备注"
操作类型: 推荐修改
置信度: 1.0
来源: 用户修改
用户: user_001
保存时间: 2024-12-20 10:40:00

用户操作类型4 - 人工干预（拖拽连线）:
原始字段: "代号"
标准字段: "序号"
操作类型: 人工干预
置信度: 1.0
来源: 用户拖拽连线
用户: user_001
保存时间: 2024-12-20 10:45:00
备注: 用户通过拖拽连线界面手动匹配
```

---

### 第二期工作流程总结

```
┌─────────────────────────────────────────────────────────────┐
│ 第二期工作流程（包含人工干预反馈和推荐确认标记）              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 1. 用户上传Word协议文档                                       │
│    ↓                                                          │
│ 2. 系统识别和过滤表格                                         │
│    ↓                                                          │
│ 3. 提取表格数据                                               │
│    ↓                                                          │
│ 4. 多层次匹配策略                                             │
│    ├─ 第一层: 知识库精确匹配                                  │
│    ├─ 第二层: 嵌入模型相似度匹配                              │
│    ├─ 第三层: 基于上下文的智能推荐                            │
│    └─ 第四层: 人工干预                                        │
│    ↓                                                          │
│ 5. 根据置信度决定处理方式                                     │
│    ├─ 高置信度(>0.85) → 自动转换 → 保存到知识库              │
│    │                                                          │
│    ├─ 中置信度(0.7-0.85) → 推荐确认                           │
│    │                      ├─ 用户确认 → 保存到知识库          │
│    │                      │          → 标记：推荐确认 ⚠️      │
│    │                      └─ 用户修改 → 直接进入人工干预      │
│    │                                                          │
│    └─ 低置信度(<0.7) → 人工干预                               │
│                      ↓                                        │
│                      双模式选择：                              │
│                      ├─ 拖拽连线方式                          │
│                      └─ 输入方式（无缝转换）                  │
│                      ↓                                        │
│                      保存到知识库                              │
│    ↓                                                          │
│ 6. 所有用户操作都自动保存到知识库                             │
│    ├─ 自动匹配 → 置信度1.0                                    │
│    ├─ 推荐确认 → 置信度0.9 → 标记：推荐确认 ⚠️               │
│    ├─ 推荐修改 → 置信度1.0                                    │
│    └─ 人工干预 → 置信度1.0                                    │
│    ↓                                                          │
│ 7. 输出Excel（含推荐确认标记）                                │
│    ├─ 推荐确认字段：黄色背景 ⚠️                               │
│    └─ 支持"推荐确认"列筛选                                    │
│    ↓                                                          │
│ 8. 知识库持续增长                                             │
│    ├─ 下次遇到相同字段 → 直接使用知识库                       │
│    └─ 减少人工干预频率                                        │
│    ↓                                                          │
│ 9. 定期模型微调和优化                                         │
│    ├─ 收集所有用户操作数据                                    │
│    ├─ 分析用户修改和人工干预的原因                            │
│    ├─ 微调模型                                                │
│    └─ 提高推荐准确率                                          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 第二期人工干预后的知识库保存机制

### 详细说明

第二期保留了第一期的人工干预机制，但增强了知识库的学习能力。所有用户操作都会自动保存到知识库，形成一个持续增长的知识库。

### 四种操作类型的知识库保存

#### 操作类型1：自动匹配（知识库精确匹配）

**场景**：系统在知识库中找到精确匹配的字段映射

**处理流程**：
```
用户上传协议文档
  ↓
系统识别字段："信号名称"
  ↓
查询知识库：找到映射关系 "信号名称" → "参数"
  ↓
自动转换
  ↓
保存到知识库（置信度1.0，来源：知识库精确匹配）
```

**知识库记录**：
```
原始字段: "信号名称"
标准字段: "参数"
操作类型: 自动匹配
置信度: 1.0
来源: 知识库精确匹配
协议类型: 总线通信协议
供应商: supplier_A
保存时间: 2024-12-20 10:30:00
用户: system
```

#### 操作类型2：推荐确认（用户确认模型推荐）

**场景**：模型推荐了一个字段映射，用户点击确认

**处理流程**：
```
用户上传协议文档
  ↓
系统识别字段："字节数"
  ↓
查询知识库：未找到精确匹配
  ↓
模型推荐："数据长度（字节）"（相似度0.92）
  ↓
显示推荐给用户
  ↓
用户点击"确认"
  ↓
自动转换
  ↓
保存到知识库（置信度0.9，来源：用户确认推荐）
```

**知识库记录**：
```
原始字段: "字节数"
标准字段: "数据长度（字节）"
操作类型: 推荐确认
置信度: 0.9
来源: 模型推荐（相似度0.92）
协议类型: 网络通信协议
供应商: supplier_B
用户确认: user_001
保存时间: 2024-12-20 10:35:00
备注: 用户快速确认了模型推荐
```

**下次处理相同字段时**：
- 如果再次遇到"字节数"字段
- 系统会在知识库中找到这条记录
- 可以直接使用这个映射关系，无需再次推荐

#### 操作类型3：推荐修改 → 直接转人工干预

**场景**：模型推荐了一个字段映射，但用户认为不对，直接跳到人工干预流程

**处理流程**：
```
用户上传协议文档
  ↓
系统识别字段："格式"
  ↓
查询知识库：未找到精确匹配
  ↓
模型推荐："参数"（相似度0.65）
  ↓
显示推荐给用户
  ↓
用户觉得不对，点击"修改"
  ↓
直接进入人工干预流程（拖拽或输入方式）
  ↓
用户选择标准字段："备注"
  ↓
自动转换
  ↓
保存到知识库（置信度1.0，来源：用户修改推荐）
```

**知识库记录**：
```
原始字段: "格式"
标准字段: "备注"
操作类型: 推荐修改
置信度: 1.0
模型推荐: "参数"（相似度0.65）
用户修改为: "备注"
协议类型: 串行通信协议
供应商: supplier_C
用户: user_001
保存时间: 2024-12-20 10:40:00
备注: 用户修改了模型推荐，说明模型在该字段上有误
```

**对模型优化的意义**：
- 这条记录表明模型在"格式"字段上的推荐有误
- 模型推荐了"参数"，但正确答案是"备注"
- 在模型微调时，可以使用这条数据作为反例
- 帮助模型学习"格式"字段应该映射到"备注"而不是"参数"

#### 操作类型4：人工干预（拖拽或输入方式）

**场景**：模型推荐的相似度太低或用户修改推荐，系统触发人工干预界面，用户可选择拖拽或输入方式进行匹配

**处理流程**：
```
用户上传协议文档
  ↓
系统识别字段："代号"
  ↓
查询知识库：未找到精确匹配
  ↓
模型推荐：相似度都<0.7（低置信度）或用户修改推荐
  ↓
触发人工干预界面
  ↓
用户选择匹配方式：
  ├─ 方式1：拖拽连线
  │   用户拖拽"代号"连接到"序号"
  │   ↓
  │   用户点击"保存映射关系"
  │
  └─ 方式2：输入方式（无缝转换）
      用户在输入框中输入或选择"序号"
      ↓
      系统自动完成匹配
  ↓
自动转换
  ↓
保存到知识库（置信度1.0，来源：用户人工干预）
```

**知识库记录**：
```
原始字段: "代号"
标准字段: "序号"
操作类型: 人工干预
置信度: 1.0
来源: 用户拖拽连线 或 用户输入
协议类型: 总线通信协议
供应商: supplier_D
用户: user_001
保存时间: 2024-12-20 10:45:00
备注: 用户通过人工干预界面手动匹配，说明这是一个新的字段映射关系
```

**人工干预界面特点**：
- **双模式支持**：拖拽和输入方式无缝转换，避免界面交互卡住
- **拖拽模式**：可视化连线，直观易用
- **输入模式**：快速输入，支持自动补全和搜索
- **灵活切换**：用户可随时在两种方式间切换

**对知识库的意义**：
- 这是一个全新的字段映射关系
- 下次遇到"代号"字段时，系统可以直接使用这个映射关系
- 无需再次进行人工干预

### 知识库的持续增长

**第一个协议文档处理**：
```
处理100个字段
- 自动匹配: 70个 → 保存70条记录
- 推荐确认: 20个 → 保存20条记录
- 推荐修改: 5个 → 保存5条记录
- 人工干预: 5个 → 保存5条记录
知识库总数: 100条
```

**第二个协议文档处理**：
```
处理100个字段
- 自动匹配: 85个（比第一个增加15个）→ 保存85条记录
- 推荐确认: 10个（减少10个）→ 保存10条记录
- 推荐修改: 3个（减少2个）→ 保存3条记录
- 人工干预: 2个（减少3个）→ 保存2条记录
知识库总数: 200条
```

**第三个协议文档处理**：
```
处理100个字段
- 自动匹配: 92个（继续增加）→ 保存92条记录
- 推荐确认: 5个（继续减少）→ 保存5条记录
- 推荐修改: 2个（继续减少）→ 保存2条记录
- 人工干预: 1个（继续减少）→ 保存1条记录
知识库总数: 300条
```

**趋势分析**：
- 自动匹配率从70% → 85% → 92%（持续增长）
- 人工干预率从5% → 2% → 1%（持续下降）
- 知识库从100条 → 200条 → 300条（持续增长）
- 系统效率不断提高

### 知识库查询优先级

当处理一个新的字段时，系统按以下优先级查询知识库：

```
1. 精确匹配（操作类型：自动匹配）
   - 查询条件：原始字段完全相同
   - 置信度：1.0
   - 处理：直接使用，无需推荐

2. 精确匹配（操作类型：人工干预）
   - 查询条件：原始字段完全相同
   - 置信度：1.0
   - 处理：直接使用，无需推荐

3. 精确匹配（操作类型：推荐修改）
   - 查询条件：原始字段完全相同
   - 置信度：1.0
   - 处理：直接使用，无需推荐

4. 精确匹配（操作类型：推荐确认）
   - 查询条件：原始字段完全相同
   - 置信度：0.9
   - 处理：直接使用，无需推荐

5. 模型推荐
   - 查询条件：计算相似度
   - 置信度：0.7-0.95
   - 处理：显示推荐给用户

6. 人工干预
   - 查询条件：无匹配
   - 置信度：<0.7
   - 处理：触发拖拽连线界面
```

---

## 两期对比总结

| 功能特性 | 第一期 | 第二期 |
|---------|--------|--------|
| **匹配方式** | 知识库精确匹配 | 多层次匹配（精确+模糊） |
| **人工干预** | 频繁（新字段需要人工匹配） | 较少（模型推荐可快速确认） |
| **人工干预后处理** | 自动保存到知识库 | 自动保存到知识库 |
| **学习能力** | 被动学习（用户手动添加） | 主动学习（从所有操作中优化） |
| **知识库增长** | 线性增长（用户干预时） | 加速增长（所有操作都保存） |
| **处理速度** | 快（简单查询） | 中等（需要模型推理） |
| **准确率** | 100%（精确匹配） | 85-95%（取决于模型） |
| **扩展性** | 需要手动扩展知识库 | 自动学习新的字段映射 |
| **用户体验** | 需要频繁干预 | 大多数情况自动处理 |
| **维护成本** | 低（知识库维护） | 中等（模型维护和优化） |
| **知识库复用** | 高（精确匹配） | 更高（精确+推荐都可复用） |

---

## 实现建议

### 第一期实现建议
1. **优先级**：知识库系统 > 表格识别 > 人工干预界面 > 数据转换
2. **技术栈**：Python后端 + Web前端（拖拽界面）
3. **存储**：SQLite或MySQL数据库存储知识库
4. **测试**：使用测试协议20251216.docx进行测试

### 第二期实现建议
1. **模型选择**：ERNIE 3.0 Tiny（中文优化，轻量级）
2. **优化方向**：
   - 批量推理优化
   - 缓存机制
   - 模型微调流程
3. **集成方式**：在第一期基础上添加模型推理层
4. **性能目标**：推理时间<1秒，准确率>85%

---

## 总结

### 两期规划的核心特点

这个两期规划清晰地划分了功能，并形成了一个完整的闭环系统：

**第一期**：建立基础的知识库系统
- 通过人工干预逐步积累映射关系
- 所有人工干预都自动保存到知识库
- 形成初始的知识库数据

**第二期**：利用第一期积累的数据，引入嵌入模型进行智能匹配
- 大幅降低人工干预频率
- 保留人工干预机制，继续积累新的映射关系
- 所有用户操作（包括人工干预）都自动保存到知识库
- 知识库持续增长，系统效率不断提高

### 人工干预的重要性

**第一期中的人工干预**：
- 是系统的主要学习方式
- 每次人工干预都为知识库增加新的映射关系
- 是知识库初期快速增长的关键

**第二期中的人工干预**：
- 虽然频率大幅降低，但仍然保留
- 用于处理模型无法准确推荐的字段
- 每次人工干预都为知识库增加新的映射关系
- 为模型微调提供反例数据
- 帮助系统不断学习和改进

### 知识库的持续增长机制

```
第一期：
用户干预 → 保存到知识库 → 知识库增长 → 下次自动匹配

第二期：
自动匹配 → 保存到知识库 ↓
推荐确认 → 保存到知识库 ↓
推荐修改 → 保存到知识库 ↓ → 知识库加速增长 → 下次自动匹配
人工干预 → 保存到知识库 ↓

同时：
用户操作数据 → 模型微调 → 推荐准确率提高 → 人工干预减少
```

### 系统的自我完善能力

这个设计使系统具有强大的自我完善能力：

1. **知识库自我完善**：
   - 每次用户操作都为知识库增加新数据
   - 知识库覆盖范围不断扩大
   - 自动匹配率不断提高

2. **模型自我完善**：
   - 收集用户修改和人工干预的数据
   - 定期对模型进行微调
   - 推荐准确率不断提高

3. **系统效率自我提升**：
   - 人工干预频率不断降低
   - 用户体验不断改善
   - 系统处理效率不断提高

### 最终目标

通过两期的开发和持续优化，系统最终将达到：
- **自动化程度**：>95%的字段可以自动处理
- **准确率**：>99%的自动处理结果正确
- **用户体验**：大多数情况下无需人工干预
- **知识库规模**：包含数千条映射关系
- **系统效率**：处理大型协议文档只需秒级时间

这样的设计既保证了第一期的稳定性和准确性，又为第二期的智能化升级奠定了基础，最终形成一个自我完善、不断进化的系统。

