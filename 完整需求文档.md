# 协议字段匹配工具 - 需求文档

## 项目概述

本项目是一个**协议字段匹配工具**，用于自动匹配协议字段名称到标准化的目标表头。项目分为两期开发：
- **第一期**：人工匹配 + 知识库系统（4.5周）
- **第二期**：语义匹配引擎 + 智能推荐（4周）

---

## 第一期需求：人工匹配 + 知识库系统

### 第一期核心理念

1. **人工匹配**：通过可视化界面进行人工字段匹配
2. **知识库积累**：所有人工匹配结果保存到知识库
3. **快速复用**：下次遇到相同字段直接从知识库查询
4. **基础数据**：为第二期的语义匹配提供训练数据

### 第一期核心功能需求

#### 1. 知识库系统

**需求描述**：建立协议字段到目标表头的映射关系知识库。

**知识库数据结构**：
```
字段名称: target_header
字段类型: 字符串
说明: 目标表头（唯一）
示例: "协议名称"、"入参"、"出参"

字段名称: protocol_field
字段类型: 字符串
说明: 协议字段
示例: "协议名"、"名称"、"协议标识"

字段名称: table_id（可选）
字段类型: 字符串
说明: 关联表格的唯一标识，针对不同来源的协议对应不同的表格
示例: "supplier_001"、"supplier_002"

字段名称: confidence
字段类型: 浮点数
说明: 匹配的置信度（人工标注时填写1.0）
示例: 1.0

字段名称: label_time
字段类型: 时间戳
说明: 标注/更新时间
示例: 2024-05-20 14:30:00

字段名称: labeler
字段类型: 字符串
说明: 人工标注者ID
示例: "user_001"
```

**实现要求**：
- MySQL数据库存储
- 支持增删改查操作
- 支持按条件查询
- 快速查询响应

**实际例子**：
```
知识库条目1：
- target_header: "协议名称"
- protocol_field: "协议名"
- table_id: "supplier_001"
- confidence: 1.0
- label_time: 2024-12-20 10:30:00
- labeler: "user_001"

知识库条目2：
- target_header: "入参"
- protocol_field: "输入参数"
- table_id: "supplier_001"
- confidence: 1.0
- label_time: 2024-12-20 10:35:00
- labeler: "user_001"
```

#### 2. 人工匹配界面

**需求描述**：提供可视化界面进行人工字段匹配。

**界面布局**：
```
┌─────────────────────────────────────────────┐
│ 协议字段              目标表头              │
├─────────────────────────────────────────────┤
│ ┌──────────────┐    ┌──────────────┐       │
│ │ 协议名       │───→│ 协议名称     │       │
│ │ 输入参数     │───→│ 入参         │       │
│ │ 输出参数     │───→│ 出参         │       │
│ │ 参数类型     │    │ 数据类型     │       │
│ │ 参数值       │    │ 参数值       │       │
│ └──────────────┘    └──────────────┘       │
│                                             │
│ [保存映射关系] [重置] [查询知识库]          │
└─────────────────────────────────────────────┘
```

**功能特点**：
- 左侧显示协议字段
- 右侧显示目标表头列表
- 支持拖拽连线进行匹配
- 支持手动删除连线
- 实时显示连线状态
- 简单的错误提示

**实际例子**：
```
协议字段列表：
- 协议名
- 输入参数
- 输出参数
- 参数类型
- 参数值

目标表头列表：
- 协议名称
- 入参
- 出参
- 数据类型
- 值

用户拖拽连线：
协议名 → 协议名称
输入参数 → 入参
输出参数 → 出参
参数类型 → 数据类型
参数值 → 值
```

#### 3. Word文件导入功能

**需求描述**：用户导入Word文档进行协议转换。系统将Word文件复制到本地固定目录，然后进行解析。

**实现要求**：
- 支持Word文件上传（.docx格式）
- 将上传的文件复制到本地固定目录
- 生成唯一的文件名（带时间戳）
- 验证文件格式和完整性
- 记录导入日志

**实际例子**：
```
用户上传：protocol_test.docx

系统处理：
1. 验证文件格式 → .docx ✓
2. 生成唯一名称 → word_20241220_103000.docx
3. 复制到本地目录 → /data/uploads/word_20241220_103000.docx
4. 验证文件完整性 → ✓
5. 返回文件路径给后续处理模块

后续处理：
系统从本地路径读取文件 → 识别表格 → 映射字段 → 填充模板
```

#### 4. 表格识别功能

**需求描述**：识别Word文档中的表格，包括表头识别和不同格式的表格支持。

**实现要求**：
- 识别Word文档中的所有表格
- 识别表格表头（第一行通常是表头）
- 支持横向表格（标准格式）
- 支持纵向表格（竖排格式）
- 支持混合表格（部分横向部分纵向）
- 提取表格数据结构

**实际例子**：

横向表格：
```
| 协议名 | 输入参数 | 输出参数 |
|--------|---------|---------|
| 协议A  | 方法参数 | 返回值   |
| 协议B  | 入参     | 出参     |
```

纵向表格：
```
| 属性 | 值 |
|------|-----|
| 协议名 | 协议A |
| 输入参数 | 方法参数 |
| 输出参数 | 返回值 |
```

#### 5. 多表跨表数据读取

**需求描述**：支持从多个表格中读取数据，并进行跨表关联。第一期实现基础版本，第二期细化功能。

**第一期实现要求**：
- 识别文档中的多个表格
- 按顺序读取表格数据
- 简单的数据合并（直接拼接）
- 支持基本的表格关联（通过相同字段）
- 记录表格处理日志

**第一期实际例子**：
```
Word文档中有2个表格：

表格1（协议基本信息）：
| 协议名 | 版本 |
|--------|------|
| 协议A  | 1.0  |

表格2（协议详细信息）：
| 协议名 | 输入参数 | 输出参数 |
|--------|---------|---------|
| 协议A  | 方法参数 | 返回值   |

系统处理：
1. 识别两个表格
2. 按表格1的"协议名"关联表格2
3. 合并数据：协议A, 1.0, 方法参数, 返回值
```

**第二期细化需求**：
- 复杂的跨表关联逻辑
- 支持多字段关联
- 支持条件筛选
- 支持数据转换和计算
- 支持错误处理和数据验证

#### 6. 知识库查询功能

**需求描述**：快速查询知识库中的映射关系。

**实现要求**：
- 按协议字段查询
- 按目标表头查询
- 按来源(table_id)查询
- 模糊查询支持

**实际例子**：
```
查询1：查询"协议名"的映射
结果：协议名 → 协议名称 (confidence: 1.0)

查询2：查询来自"supplier_001"的所有映射
结果：
- 协议名 → 协议名称
- 输入参数 → 入参
- 输出参数 → 出参

查询3：模糊查询"参数"相关的映射
结果：
- 输入参数 → 入参
- 输出参数 → 出参
- 参数类型 → 数据类型
```

#### 7. 数据输出与模板管理

**需求描述**：用户导入Word文档进行协议转换时，系统自动识别数据、复制模板文件并自动填充结果。

**实现要求**：
- 维护标准的Excel模板文件（不变）
- 用户导入Word文档时自动触发处理
- 系统自动识别表格和数据
- 系统自动复制模板文件
- 系统自动填充识别的数据到模板
- 系统自动保存输出文件
- 用户直接获得结果文件

**实际例子**：

标准模板文件（template.xlsx）- 保存在服务器，永不改变：
```
| 序号 | 协议名称 | 入参 | 出参 | 数据类型 |
|------|---------|------|------|---------|
| 1    | [待填充] | [待填充] | [待填充] | [待填充] |
| 2    | [待填充] | [待填充] | [待填充] | [待填充] |
```

自动处理流程：
```
1. 用户导入Word文档（协议转换）
2. 系统自动识别表格和数据
3. 系统查询知识库进行字段映射
4. 系统复制模板文件 → result_20241220_103000.xlsx
5. 系统自动填充识别和映射的数据
6. 系统自动保存输出文件
7. 用户直接获得result_20241220_103000.xlsx

输出文件（result_20241220_103000.xlsx）- 已自动填充：
| 序号 | 协议名称 | 入参 | 出参 | 数据类型 |
|------|---------|------|------|---------|
| 1    | 协议A    | 方法参数 | 返回值 | 类型 |
| 2    | 协议B    | 入参 | 出参 | 数据类型 |
```

#### 8. 错误处理和日志

**需求描述**：完整的错误处理和日志系统。

**实现要求**：
- 详细的错误处理
- 完整的日志记录
- 错误追踪

### 第一期前端需求

#### 1. 基本页面结构

- **首页/仪表板**：显示系统概览和最近处理的匹配
- **匹配页面**：手动进行字段匹配
- **批量处理页面**：上传文件，批量处理
- **知识库管理页面**：查看和管理知识库
- **历史记录页面**：显示处理历史

#### 2. 匹配交互

**界面示例**：
```
┌──────────────────────────────────────────┐
│ 协议字段          目标表头              │
├──────────────────────────────────────────┤
│ 协议名     ───→  协议名称               │
│ 输入参数   ───→  入参                   │
│ 输出参数   ───→  出参                   │
│ 参数类型   ───→  数据类型               │
│                                        │
│ [保存] [重置] [知识库查询]              │
└──────────────────────────────────────────┘
```

#### 3. 知识库管理

**功能**：
- 查看知识库条目
- 搜索功能
- 按来源筛选
- 显示匹配统计

#### 4. 批量处理

**功能**：
- 上传CSV/Excel文件
- 显示处理进度
- 导出处理结果
- 显示错误信息

### 第一期前端需求

#### 1. 基本页面结构
- **首页/仪表板**：显示系统概览和最近处理的匹配
- **匹配页面**：手动进行字段匹配
- **批量处理页面**：上传文件，批量处理
- **知识库管理页面**：查看和管理知识库
- **历史记录页面**：显示处理历史

#### 2. 人工匹配功能
- 显示协议字段列表
- 显示目标表头列表
- 支持拖拽连线进行匹配
- 显示连线状态
- 保存映射关系
- 查询知识库

#### 3. 知识库管理
- 查看知识库条目
- 搜索功能
- 按来源(table_id)筛选
- 显示匹配统计
- 编辑条目（可选）

#### 4. 批量处理
- 上传CSV/Excel文件
- 显示处理进度
- 导出处理结果
- 显示错误信息

#### 5. 错误提示和加载状态
- 实现错误提示组件
- 实现加载状态显示
- 实现用户反馈提示

### 第一期交付成果

1. ✅ 知识库系统（MySQL）
2. ✅ 人工匹配界面（拖拽连线）
3. ✅ 知识库查询功能
4. ✅ 知识库管理界面
5. ✅ 批量处理功能
6. ✅ 基本前端页面
7. ✅ 历史记录页面
8. ✅ 错误处理和日志
9. ✅ 完整的单元测试（覆盖率>80%）
10. ✅ API文档
11. ✅ 可部署到测试环境

---

## 第二期需求：语义匹配引擎 + 智能推荐

### 第二期核心理念

1. **自动化匹配**：使用语义相似度自动匹配协议字段到标准表头
2. **置信度判断**：根据相似度设置阈值，区分高置信度和低置信度
3. **智能推荐**：为低置信度匹配提供推荐候选项
4. **知识库优化**：使用用户反馈优化知识库
5. **大文件处理**：支持处理包含几十个表格的大文件，不卡死前端

### 第二期核心功能需求

#### 0. 大文件处理和前端不卡顿

**需求描述**：确保用户上传和处理大文件（几十个表格）时前端不卡死，提供处理进度显示。同时支持用户手动输入匹配关系并保存到知识库。

**实现要求**：
- 文件上传时显示进度条（不阻塞前端）
- 表格识别处理时显示进度
- 拖拽连线时不卡死（异步处理）
- 支持用户手动输入协议字段和目标表头进行匹配
- 手动输入的匹配关系实时保存到知识库
- 支持批量手动输入

**实际例子**：

场景1 - 大文件上传和处理进度：
```
文件上传进度：
上传中... 45% ▓▓▓▓▓░░░░░

文件处理进度：
识别表格... 30% ▓░░░░░░░░░
表格关联... 20% ▓░░░░░░░░░
字段映射... 10% ░░░░░░░░░░
```

场景2 - 手动输入匹配并保存到知识库：
```
手动匹配输入：

协议字段：[输入框：协议名]
目标表头：[下拉选择：协议名称]

[保存到知识库] [继续添加]

或

批量输入：
协议名 → 协议名称 ✓ 已保存
输入参数 → 入参 ✓ 已保存
输出参数 → 出参 ✓ 已保存

[保存全部到知识库]
```

**实现方式**：
- 前端使用Web Worker处理大文件
- 异步处理表格识别
- WebSocket实时推送进度
- 拖拽操作使用防抖处理
- 手动输入实时验证和保存到知识库

#### 1. 预处理模块

**需求描述**：对输入的表头和协议字段进行标准化处理。

**详细说明**：
- 去除空格（首尾和中间）
- 统一小写处理
- 修正常见笔误（如"形号→型号"）
- 处理特殊符号

**实际例子**：
```
输入："  协议 名 称  "
处理步骤：
1. 去除空格 → "协议名称"
2. 统一小写 → "协议名称"
3. 笔误修正 → "协议名称"
输出："协议名称"
```

#### 2. 向量生成模块

**需求描述**：使用ERNIE 3.0 Tiny模型将文本转化为向量。

**模型选择**：
- **ERNIE 3.0 - Tiny**（推荐）
  - 中文领域优化模型
  - 对中文术语、缩略词、同义词的捕捉能力强
  - 模型体积约100M
  - 支持CPU推理，单条匹配耗时<10ms
  - 部署成本低

**实现要求**：
- 模型加载和初始化
- 批量向量生成
- 向量缓存机制

#### 3. 相似度计算模块

**需求描述**：采用余弦相似度计算两组向量的关联度。

**实际例子**：
```
协议字段："协议名"
目标表头列表：["协议名称", "协议标识", "协议号", "名称"]

相似度计算：
- vs "协议名称"：0.92 ✅ 高置信度（≥0.7）
- vs "协议标识"：0.68 ❌ 低置信度（<0.7）
- vs "协议号"：0.65 ❌ 低置信度（<0.7）
- vs "名称"：0.58 ❌ 低置信度（<0.7）

结果：
- 自动匹配到"协议名称"（相似度0.92）
- 其他候选项供用户参考
```

#### 4. 置信度判断模块

**需求描述**：根据相似度设置阈值，区分高置信度和低置信度匹配。

**实现要求**：
- 设定置信度阈值（默认0.7）
- 相似度≥阈值：高置信度匹配，自动输出
- 相似度<阈值：低置信度匹配，转人工处理
- 支持自定义阈值

#### 5. 智能推荐功能

**需求描述**：为低置信度匹配提供推荐候选项。

**推荐界面**：
```
┌──────────────────────────────────────────┐
│ 协议字段：协议标识                       │
├──────────────────────────────────────────┤
│ 系统推荐：                               │
│ 1. 协议名称      相似度 0.92 ✅ 高置信  │
│ 2. 协议标识      相似度 0.68 ⚠️ 低置信 │
│ 3. 协议号        相似度 0.65 ⚠️ 低置信 │
│                                        │
│ 我的选择：[协议名称 ▼]                 │
│                                        │
│ [确认] [取消] [保存到知识库]            │
└──────────────────────────────────────────┘
```

#### 6. 知识库优化

**需求描述**：使用用户反馈优化知识库。

**实现要求**：
- 收集用户反馈
- 更新置信度
- 识别错误匹配
- 清理过期数据

#### 7. 模型微调

**需求描述**：使用知识库数据微调ERNIE 3.0 Tiny模型。

**实现要求**：
- 准备训练数据
- 微调模型
- 评估模型性能
- 版本管理

### 第二期前端需求

#### 1. 智能匹配界面

**界面示例**：
```
┌──────────────────────────────────────────┐
│ 输入协议字段：[协议名  ▼]               │
├──────────────────────────────────────────┤
│ 系统推荐：协议名称 (相似度 0.92)        │
│ 状态：✅ 高置信度，自动匹配             │
│                                        │
│ 其他候选项：                           │
│ - 协议标识 (0.68)                      │
│ - 协议号 (0.65)                        │
│                                        │
│ [确认] [修改] [保存到知识库]            │
└──────────────────────────────────────────┘
```

#### 2. 用户反馈UI

**功能**：
- 收集用户对推荐的反馈
- 显示反馈结果
- 统计反馈数据

#### 3. 模型对比工具

**功能**：
- 显示不同模型的匹配结果
- 显示性能指标对比
- 支持模型切换

### 第二期前端需求

#### 1. 智能匹配界面

**界面示例**：
```
┌──────────────────────────────────────────┐
│ 输入协议字段：[协议名  ▼]               │
├──────────────────────────────────────────┤
│ 系统推荐：协议名称 (相似度 0.92)        │
│ 状态：✅ 高置信度，自动匹配             │
│                                        │
│ 其他候选项：                           │
│ - 协议标识 (0.68)                      │
│ - 协议号 (0.65)                        │
│                                        │
│ [确认] [修改] [保存到知识库]            │
└──────────────────────────────────────────┘
```

**功能**：
- 输入协议字段
- 显示系统推荐
- 显示相似度分数
- 显示置信度状态
- 显示候选项列表
- 支持用户选择
- 支持保存到知识库

#### 2. 用户反馈UI

**功能**：
- 收集用户对推荐的反馈
- 显示反馈结果
- 统计反馈数据

#### 3. 模型对比工具

**功能**：
- 显示不同模型的匹配结果
- 显示性能指标对比
- 支持模型切换

#### 4. 前端优化

**优化项**：
- 前端渲染优化
- 网络请求优化
- 缓存优化

### 第二期交付成果

1. ✅ 预处理模块
2. ✅ 向量生成模块（ERNIE 3.0 Tiny）
3. ✅ 相似度计算模块
4. ✅ 置信度判断模块
5. ✅ 智能推荐功能
6. ✅ 知识库优化模块
7. ✅ 模型微调功能
8. ✅ 用户反馈收集系统
9. ✅ 模型对比工具
10. ✅ 智能匹配前端界面
11. ✅ 完整的集成测试（覆盖率>80%）
12. ✅ 用户文档
13. ✅ 可部署到生产环境

---

## 时间规划

### 第一期时间规划（4.5周）

| 周次 | 主题 | 主要工作 | 协作 |
|------|------|---------|------|
| 第1周 | 基础框架 | 后端框架、前端框架、API设计 | 评审设计 |
| 第2周 | 知识库系统 | 知识库CRUD、匹配界面、拖拽连线 | 集成测试 |
| 第3周 | 继续知识库 | 知识库完善、API完善、匹配完善 | 集成测试 |
| 第4周 | 批量处理 | 批量处理、批量UI、知识库管理 | 集成测试 |
| 第4.5周 | 测试优化 | 性能优化、文档、bug修复 | 联合测试 |

### 第二期时间规划（4周）

| 周次 | 主题 | 主要工作 | 协作 |
|------|------|---------|------|
| 第1-1.5周 | 预处理和向量 | 预处理、向量生成、相似度计算 | 评审设计 |
| 第1.5-3周 | 推荐和优化 | 置信度判断、推荐、知识库优化 | 集成测试 |
| 第3-4周 | 模型和优化 | 模型微调、性能优化、前端优化 | 性能测试 |
| 第4周 | 集成和部署 | 集成测试、用户验收、部署 | 联合测试 |

---

## 性能要求

| 指标 | 目标 | 说明 |
|------|------|------|
| 单条匹配 | <10ms | ERNIE 3.0 Tiny CPU推理（第二期） |
| 知识库查询 | <50ms | 单次查询（第一期） |
| 批量处理 | <100ms | 10条字段（第一期） |
| 前端响应 | <300ms | 用户交互 |
| 页面加载 | <1秒 | 首屏加载 |

---

## 技术栈

### 后端技术栈
- FastAPI - Web框架
- SQLAlchemy - ORM
- MySQL - 数据库
- ERNIE 3.0 Tiny - 词嵌入模型（第二期）
- numpy/scipy - 向量计算（第二期）
- pytest - 单元测试
- flake8/mypy - 代码质量

### 前端技术栈
- Vue 3 - 前端框架
- Vite - 构建工具
- Element Plus - UI库
- axios - HTTP客户端
- Pinia - 状态管理
- Vitest - 单元测试
- ESLint/Prettier - 代码风格

---

## 质量标准

### 代码覆盖率目标
- 后端核心模块：>85%
- 后端API：>80%
- 前端组件：>80%
- 集成测试：>70%

### 代码风格
- 后端：PEP 8规范，使用black、flake8、mypy
- 前端：ESLint规范，使用Prettier

### PR审查规范
1. 每个PR必须有清晰的描述
2. 必须通过所有自动化测试
3. 必须经过对方代码审查
4. 必须有新增功能的单元测试
5. 必须更新相关文档

---

## 项目总结

### 核心理念

**第一期：人工匹配 + 知识库系统**
- 人工匹配：通过可视化界面进行人工字段匹配
- 知识库积累：所有人工匹配结果保存到知识库
- 快速复用：下次遇到相同字段直接从知识库查询
- 基础数据：为第二期的语义匹配提供训练数据

**第二期：语义匹配引擎 + 智能推荐**
- 自动化匹配：使用语义相似度自动匹配协议字段
- 置信度判断：区分高置信度和低置信度匹配
- 智能推荐：为低置信度匹配提供推荐候选项
- 知识库优化：使用用户反馈优化知识库
- 模型微调：使用知识库数据微调ERNIE 3.0 Tiny

### 工作流程对比

**第一期流程**：
```
上传协议字段 → 查询知识库
  ├─ 找到 → 自动应用
  └─ 未找到 → 人工匹配 → 保存到知识库
```

**第二期流程**：
```
上传协议字段 → 预处理 → 向量生成 → 相似度计算
  ├─ 高置信度 → 自动匹配
  └─ 低置信度 → 推荐候选项 → 用户确认 → 保存到知识库
```

### 关键指标

| 指标 | 第一期 | 第二期 |
|------|--------|--------|
| 匹配方式 | 人工+知识库 | 语义相似度 |
| 人工干预 | 100% | 较少（低置信度） |
| 准确率 | 100%（人工） | 85-95% |
| 知识库查询 | <50ms | <50ms |
| 单条匹配 | - | <10ms |

### 交付成果

**第一期**：完整的知识库系统和人工匹配界面，为第二期提供基础数据

**第二期**：语义匹配引擎和智能推荐系统，实现自动化匹配

